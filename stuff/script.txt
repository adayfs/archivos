/************** CONFIGURACIÓN ÚNICA **************/
const CFG = {
  // === WordPress ===
  WP_URL:   'https://adayfs.com',
  WP_USER:  'admin',
  WP_APP_PASS: 'Kz2T Dbj2 uFqR lTLK o9wJ Hn9D', // se envía sin espacios

  // === Google Docs ===
  DOC_ID_SESIONES: '1-kKaUQSNrxeDseNIIZ39vYXe6FMFESwU1lOyEKd5kyo',  // Diario
  DOC_ID_FICHAS:   '1FI2JUCx1Gg71zmvs8HUzdgITpqG1gTOZB8pqSvD9vvY',  // Fichas

  // === Categorías (nombres EXACTOS en WP) ===
  CAT_DIARIO:  'Diario',
  CAT_NPC:     'NPC',
  CAT_LUGARES: 'Lugares',
  CAT_PJ:      'PJ',

  // === Base de categorías en “Enlaces permanentes” ===
  CATEGORY_BASE: 'wiki',

  // Slugs visibles para construir URLs estables
  CAT_SLUGS: { NPC:'npc', Lugares:'lugares', PJ:'pj', Diario:'diario' },

  // Publicación automática
  PUBLICAR_SESIONES: true,
  PUBLICAR_FICHAS_ACTUALIZADAS: true,
  PUBLICAR_FICHAS_CREADAS: true,

  // Crear ficha si no existe cuando la detectamos en el Diario
  CREATE_MISSING_WHEN_LINKING: true,

  // ==== PLACEHOLDERS (IDs de la Mediateca) ====
  // Pon aquí los IDs de las imágenes placeholder ya subidas a tu Mediateca.
  PLACEHOLDERS: {
    Diario:   0,   // si 0, no se pone placeholder para Diario
    NPC:      2880,
    Lugares:  2880,
    PJ:       2880,
    default:  0
  }
};
/**************************************************/

/** =================== FLUJO 1: SESIONES (DIARIO) =================== **/
function importarSesionesDesdeDoc() {
  const body = DocumentApp.openById(CFG.DOC_ID_SESIONES).getBody().getText();

  const catDiarioId  = getOrCreateCategoryId(CFG.CAT_DIARIO);
  const catIdsMap = {
    NPC:     getOrCreateCategoryId(CFG.CAT_NPC),
    Lugares: getOrCreateCategoryId(CFG.CAT_LUGARES),
    PJ:      getOrCreateCategoryId(CFG.CAT_PJ)
  };

  const sesiones = parseSesiones(body);
  if (!sesiones.length){ Logger.log('No hay sesiones.'); return; }

  sesiones.forEach(s => {
    // 1) Mapa de enlaces (crea/asegura fichas y arma hrefs estables)
    const linkMap = {};
    [
      {list:s.pjs, tipo:'PJ'},
      {list:s.npcs, tipo:'NPC'},
      {list:s.lugares, tipo:'Lugares'}
    ].forEach(({list, tipo}) => {
      unique(list).forEach(name => {
        const catId   = catIdsMap[tipo];
        const catSlug = CFG.CAT_SLUGS[tipo];
        const slug    = toSlug(name);

        let post = findPostByExactTitle(name);
        if (!post && CFG.CREATE_MISSING_WHEN_LINKING){
          post = wpPost('/wp-json/wp/v2/posts', {
            title: name,
            content: '<p>Entrada generada automáticamente desde el Diario.</p>',
            status: 'draft',
            categories: [catId],
            slug: slug,
            featured_media: pickPlaceholderId([catId])
          }, 'POST');
        } else if (post) {
          // Asegura categoría específica
          const current = (post.categories||[]).slice();
          if (current.indexOf(catId) === -1){
            const merged = Array.from(new Set([...current, catId]));
            post = wpPost(`/wp-json/wp/v2/posts/${post.id}`, { categories: merged }, 'POST');
          }
          // Asegura placeholder si no tiene
          ensureFeaturedMedia(post.id, [catId]);
        }

        const href = `${CFG.WP_URL.replace(/\/+$/,'')}/${CFG.CATEGORY_BASE}/${catSlug}/${slug}/`;
        linkMap[name] = { href };   // <— guardamos .href
      });
    });

    // 2) Enlazar TODAS las apariciones
    const linked   = linkifyAllOccurrences(s.contenido, linkMap);
    const contentHtml = paragraphsPreservingAnchors(linked);

    // 3) Crear la sesión
    const payload = {
      title: s.titulo || ('Sesión ' + (s.num||'')),
      slug:  s.num ? `sesion-${s.num}` : undefined,
      content: contentHtml,
      status: CFG.PUBLICAR_SESIONES ? 'publish' : 'draft',
      categories: [catDiarioId],
      featured_media: pickPlaceholderId([catDiarioId])   // placeholder para Diario si lo configuras
    };

    const res = wpPost('/wp-json/wp/v2/posts', payload, 'POST');
    Logger.log(`Sesión ${s.num||''} → ${res.link}`);
  });

  Logger.log(`Sesiones procesadas: ${sesiones.length}`);
}

/** =================== FLUJO 2: FICHAS DESDE DOC =================== **/
function actualizarEntradasDesdeDoc(){
  const CAT_IDS = [
    getOrCreateCategoryId(CFG.CAT_NPC),
    getOrCreateCategoryId(CFG.CAT_LUGARES),
    getOrCreateCategoryId(CFG.CAT_PJ)
  ];

  // 1) Catálogo de fichas existentes (para enlazar texto)
  const catalogo = listarPostsPorTitulo(CAT_IDS);

  // 2) Leer bloques del DOC de fichas (H1 + cuerpo)
  const bloques = parseDocByH1(CFG.DOC_ID_FICHAS);
  Logger.log('Bloques detectados: ' + bloques.length);

  // 3) Procesar cada ficha
  bloques.forEach(b => {
    const titulo = (b.title || '').trim();
    if (!titulo) return;

    const cuerpoLinkeado = linkifyAllOccurrences(b.body || '', catalogo);
    const html = paragraphsPreservingAnchors(cuerpoLinkeado);

    const existente = findPostByExactTitle(titulo);
    let categorias = [ getOrCreateCategoryId(CFG.CAT_NPC) ];
    if (existente && Array.isArray(existente.categories) && existente.categories.length){
      categorias = existente.categories.slice();
    }

    const payload = {
      title: titulo,
      content: html,
      status: existente
              ? (CFG.PUBLICAR_FICHAS_ACTUALIZADAS ? 'publish' : 'draft')
              : (CFG.PUBLICAR_FICHAS_CREADAS       ? 'publish' : 'draft'),
      categories: categorias
    };

    let res;
    if (existente){
      res = wpPost(`/wp-json/wp/v2/posts/${existente.id}`, payload, 'POST');
      Logger.log(`Actualizada: ${titulo} → ${res.link}`);
      ensureFeaturedMedia(res.id, categorias);
    } else {
      payload.featured_media = pickPlaceholderId(categorias);
      res = wpPost('/wp-json/wp/v2/posts', payload, 'POST');
      Logger.log(`Creada: ${titulo} → ${res.link}`);
    }

    // 4) Refrescar catálogo para enlazados posteriores del mismo pase
    if (res){
      catalogo[titulo.toLowerCase()] = { id: res.id, href: res.link };
    }
  });

  Logger.log('Fichas procesadas con enlazado tipo Diario.');
}

/** =================== PARSER DE SESIONES =================== **/
function parseSesiones(fullText) {
  const lines = fullText.split('\n');
  const startRe = /^\s*(?:#|&)\s*SESION\s*(\d*)\s*$/i;
  const endRe   = /^\s*FIN\s*SESION\s*#\s*$|^\s*FINSESION#\s*$/i;

  const out = [];
  let current = null;

  for (let i = 0; i < lines.length; i++) {
    const ln = lines[i];

    if (!current) {
      const m = ln.match(startRe);
      if (m) {
        const num = m[1] ? parseInt(m[1],10) : null;
        current = { num, raw: [] };
      }
      continue;
    }
    if (endRe.test(ln)) {
      const rawText = current.raw.join('\n');
      const ext = extractEntitiesAndClean(rawText);
      out.push({
        num: current.num,
        titulo: current.num ? `Sesión ${current.num}` : 'Sesión',
        contenido: ext.cleanText,
        pjs: unique(ext.pjs),
        npcs: unique(ext.npcs),
        lugares: unique(ext.lugares)
      });
      current = null;
    } else {
      current.raw.push(ln);
    }
  }
  return out;
}

// Extrae €…€ (PJ), @…@ (NPC), %…% (Lugar)
function extractEntitiesAndClean(t) {
  const pjs = [], npcs = [], lugares = [];
  const push = (arr, s) => { s = (s||'').trim(); if (s) arr.push(s); };

  t = t.replace(/€([^€]+)€/g, (_, n) => { push(pjs, n);   return n; });
  t = t.replace(/@([^@]+)@/g, (_, n) => { push(npcs, n);  return n; });
  t = t.replace(/%([^%]+)%/g, (_, n) => { push(lugares, n); return n; });

  return { pjs, npcs, lugares, cleanText: t };
}

/** =================== ENLAZADO DE TEXTO =================== **/
function linkifyAllOccurrences(plainText, linkMap) {
  if (!plainText) return '';
  const names = Object.keys(linkMap || {});
  if (!names.length) return plainText;

  const byLc = {};
  names.forEach(n => { byLc[n.toLowerCase()] = (linkMap[n] && linkMap[n].href) || ''; });

  const alt = names.slice().sort((a,b)=>b.length-a.length).map(escapeRegExp).join('|');
  const re = new RegExp(`(^|[^\\p{L}\\p{N}_])(${alt})(?=[^\\p{L}\\p{N}_]|$)`, 'giu');

  return plainText.replace(re, (full, pre, found) => {
    const href = byLc[found.toLowerCase()];
    if (!href) return full;
    return `${pre}<a href="${href}">${found}</a>`;
  });
}

function paragraphsPreservingAnchors(s) {
  if (!s) return '';
  const anchors = [];
  const reA = /<a\b[^>]*>[\s\S]*?<\/a>/gi;
  let i = 0;
  s = s.replace(reA, (m)=>`%%A${i++}%%` && (anchors.push(m), `%%A${i-1}%%`));
  s = s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  s = s.replace(/%%A(\d+)%%/g, (_,idx)=>anchors[Number(idx)]);
  return s.split('\n').map(p => p.trim() ? `<p>${p}</p>` : '<p>&nbsp;</p>').join('\n');
}

/** =================== UTILIDADES DE WP =================== **/
function getOrCreateCategoryId(name){
  const list = wpGet(`/wp-json/wp/v2/categories?search=${encodeURIComponent(name)}&per_page=50`) || [];
  const exact = list.find(c => c.name===name);
  if(exact) return exact.id;
  const created = wpPost('/wp-json/wp/v2/categories',{name},'POST');
  return created.id;
}

// status=any para encontrar también borradores
function findPostByExactTitle(title){
  const q = `/wp-json/wp/v2/posts?search=${encodeURIComponent(title)}&status=any&per_page=50`;
  const res = wpGet(q) || [];
  const tNorm = title.trim().toLowerCase();
  return res.find(p => (p.title?.rendered || '').trim().toLowerCase() === tNorm) || null;
}

function listarPostsPorTitulo(catIds) {
  const out = {};
  catIds.forEach(catId => {
    let page = 1, more = true;
    while (more) {
      const q = `/wp-json/wp/v2/posts?categories=${catId}&per_page=100&page=${page}&status=any&_fields=id,link,slug,title,categories`;
      const lista = wpGet(q) || [];
      lista.forEach(p => {
        const t = (p.title && p.title.rendered || '').trim();
        if (t) out[t.toLowerCase()] = { id: p.id, href: p.link };
      });
      more = lista.length === 100;
      page++;
    }
  });
  return out;
}

/** ======= Featured image (placeholder) ======= **/
function pickPlaceholderId(catIds){
  // catIds: array de IDs; resolvemos a nombre y devolvemos el mejor ID
  try{
    const map = {};
    ['NPC','Lugares','PJ','Diario'].forEach(name=>{
      map[getOrCreateCategoryId(CFG['CAT_'+name])] = CFG.PLACEHOLDERS[name] || 0;
    });
    for (const id of (catIds||[])){
      if (map[id]) return map[id];
    }
    return CFG.PLACEHOLDERS.default || 0;
  }catch(e){ return CFG.PLACEHOLDERS.default || 0; }
}

function ensureFeaturedMedia(postId, catIds){
  const mediaId = pickPlaceholderId(catIds);
  if (!mediaId) return;
  try {
    const p = wpGet(`/wp-json/wp/v2/posts/${postId}?_fields=featured_media`);
    if (!p || !p.featured_media || p.featured_media === 0){
      wpPost(`/wp-json/wp/v2/posts/${postId}`, { featured_media: mediaId }, 'POST');
    }
  } catch(e) {
    Logger.log('ensureFeaturedMedia error: ' + e);
  }
}

/** =================== REST helpers =================== **/
function wpGet(path){
  const url = CFG.WP_URL + path;
  const headers = { 'Authorization': basicAuthHeader() };
  const resp = UrlFetchApp.fetch(url,{method:'get',headers,muteHttpExceptions:true});
  const code = resp.getResponseCode();
  if(code>=300) throw new Error(`GET ${url} → ${code} | ${resp.getContentText()}`);
  return JSON.parse(resp.getContentText());
}

function wpPost(path,data,method){
  const url = CFG.WP_URL + path;
  const headers = { 'Authorization': basicAuthHeader(), 'Content-Type':'application/json' };
  const resp = UrlFetchApp.fetch(url,{
    method:(method||'post'),
    headers,
    payload: JSON.stringify(data),
    muteHttpExceptions:true
  });
  const code = resp.getResponseCode();
  if(code>=300) throw new Error(`${method||'POST'} ${url} → ${code} | ${resp.getContentText()}`);
  return JSON.parse(resp.getContentText());
}

function basicAuthHeader(){
  const token = Utilities.base64Encode(CFG.WP_USER + ':' + CFG.WP_APP_PASS.replace(/\s+/g,'')); // sin espacios
  return 'Basic ' + token;
}

/** =================== util =================== **/
function unique(a){ return Array.from(new Set(a||[])); }
function escapeRegExp(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function toSlug(s){ return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .replace(/[^a-zA-Z0-9]+/g,'-').replace(/^-+|-+$/g,'').toLowerCase(); }

/** ======= PARSER DE FICHAS (H1 + cuerpo) ======= **/
function parseDocByH1(docId){
  const doc = DocumentApp.openById(docId);
  const paras = doc.getBody().getParagraphs();
  const blocks = [];
  let current = null;
  paras.forEach(p => {
    const t = p.getText() || '';
    const st = p.getHeading();
    const isH1 = (st === DocumentApp.ParagraphHeading.HEADING1) || /^#\s*/.test(t);
    if (isH1) {
      if (current) blocks.push(current);
      const title = t.replace(/^#\s*/,'').trim();
      current = { title, body: [] };
    } else if (current) {
      current.body.push(t);
    }
  });
  if (current) blocks.push(current);
  return blocks.map(b => ({ title: b.title, body: (b.body||[]).join('\n').trim() }));
}
